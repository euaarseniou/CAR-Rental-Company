#a.Show the reservation number and the location ID of all rentals on 5/20/2015

SELECT reserv_nr, pickuplocation_id
FROM rental
WHERE pickup_date = '2015-05-20';
 
 
#b. Show the first and the last name and the mobile phone number of these customers 
#that have rented a car in the category that has label = 'luxury'

SELECT first_name "First Name", last_name "Last Name", phone_nr "phone numbers of customers in category luxury"
FROM customer as c, rental as r, car, category
WHERE  c.customer_id=r.customer_id and r.VIN=car.VIN and car.categ_id=category.categ_id and category.label='luxury';

#c. Show the total amount of rentals per location ID (pick up)

SELECT pickuplocation_id "location ID", round(sum(amount),2) "Total amount of rentals"
FROM rental
group by pickuplocation_id;


#d. Show the total amount of rentals per car's category ID and month

select car.categ_id "Category ID",  extract(year from r.pickup_date) "Year", extract(month from r.pickup_date) "Month", round(sum(amount),2) "Total amount of rentals"
from  rental as r, car 
where r.VIN=car.VIN
group by car.categ_id, year, month
order by car.categ_id ASC, year ASC, month ASC;


#e. For each rental’s state (pick up) show the top renting category

Drop view if exists State;

create view State as
select state, label, count(reserv_nr) as rentals
from location, category, rental, car  
where rental.pickuplocation_id=location.location_id and rental.VIN=car.VIN and category.categ_id=car.categ_id
group by location.state, category.categ_id
order by location.state, rentals DESC;

select state, label , max(rentals) "Total Rentals for top renting category"
from State
group by state;


#f. Show how many rentals there were in May 2015 in ‘NY’, ‘NJ’ and ‘CA’ (in three columns)

DROP VIEW IF EXISTS may2015;

create view may2015 as
select state, count(reserv_nr) as rentals
from location, rental
where rental.pickuplocation_id=location.location_id and 
	(location.state="NY" or location.state="NJ" or location.state="CA") and 
	extract(year from rental.pickup_date)='2015' and 
	extract(month from rental.pickup_date)='5'
group by location.state; 

select
  max(case when state = 'CA' then rentals end) AS CA,
  max(case when state = 'NY' then rentals end) AS NY,
  max(case when state = 'NJ' then rentals end) AS NJ
from may2015;

        
#g. For each month of 2015, count how many rentals had amount greater than this month's average rental amount

SELECT count(reserv_nr) AS rentals, month(pickup_date) AS month, year(pickup_date) AS year
FROM rental AS r1
WHERE year(r1.pickup_date)=2015 AND r1.amount > (SELECT avg(r2.amount)								                              
                                                 FROM rental AS r2
						 WHERE month(r1.pickup_date)=month(r2.pickup_date) and year(r1.pickup_date)=year(r2.pickup_date) 
                                                 GROUP BY month(r2.pickup_date))
GROUP BY month(r1.pickup_date);


#h. For each month of 2015, show the percentage change of the total amount of rentals over the total amount 
#of rentals of the same month of 2014

SELECT year(pickup_date), month(pickup_date) AS month, 
ROUND((sum(amount)- r2.sum2014) * 100 / sum(amount), 2) AS percentage
FROM rental AS r1
INNER JOIN (SELECT month(pickup_date) month, round(sum(AMOUNT),2) AS sum2014
            FROM rental
			WHERE year(pickup_date)="2014"
            GROUP BY MONTH(pickup_date)
		    ORDER BY month(pickup_date) ASC) as r2
ON month(r1.pickup_date)= r2.month
WHERE year(r1.pickup_date)="2015"
GROUP BY MONTH(r1.pickup_date)
ORDER BY month(r1.pickup_date) ASC;


#i. For each month of 2015, show in three columns: the total rentals’ amount of the previous months, the 
#total rentals’ amount of this month and the total rentals’ amount of the following months

DROP VIEW IF EXISTS V2;

CREATE VIEW V2 AS
SELECT MONTH(pickup_date) AS current_month, SUM(amount) AS current_amount
FROM rental
WHERE YEAR(pickup_date) = '2015'
GROUP BY MONTH(pickup_date)
ORDER BY MONTH(pickup_date);

SELECT i.current_month AS month_number, 
     (SELECT SUM(current_amount) AS sum_amount
      FROM V2
      WHERE current_month < i.current_month) AS Previous_Month, i.current_amount AS Current_Month,
                    (SELECT SUM(current_amount) AS sum_amount
                     FROM V2
                     WHERE current_month > i.current_month) AS Next_Month
FROM V2 i
ORDER BY month_number asc;